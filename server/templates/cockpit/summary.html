{% extends "_layouts/base.html" %}
{% block title %}Queen Cockpit — Summary{% endblock %}
{% set page_id = "summary" %}

{% block top %}
  <h1 class="title">
    Queen Cockpit — <span class="q-muted">Summary</span>
    <span id="sessionBadge" class="session-badge">—</span>
  </h1>
{% endblock %}

{% block content %}
<div class="q-box p-4">
  <!-- Root that JS will populate -->
  <div id="summaryRoot"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ------------------------------------------------------------------
   SUMMARY PAGE — build UI + wire events + render cards
   ------------------------------------------------------------------ */

async function refreshSummary() {
  const intervalEl = document.getElementById('interval');
  const symbolsEl  = document.getElementById('symbols');
  const bookEl     = document.getElementById('book');
  const refreshBtn = document.getElementById('refresh');

  console.log('Summary controls snapshot', {
    intervalEl, symbolsEl, bookEl, refreshBtn
  });

  if (!intervalEl || !symbolsEl || !bookEl || !refreshBtn) {
    console.warn('Summary controls not ready yet (missing inputs)');
    return;
  }
  if (!window.qs || !qs.noStore) {
    console.warn('qs helpers not ready yet');
    return;
  }

  qs.spinGrid("sumGrid");

  const iv   = intervalEl.value || '15';
  const raw  = (symbolsEl.value || '').trim();
  const book = bookEl.value || 'all';

  const syms = raw
    ? raw.split(',').map(s => s.trim()).filter(Boolean)
    : [];

  const url = new URL('/cockpit/api/summary', window.location.origin);
  url.searchParams.set('interval', iv);
  url.searchParams.set('book', book);
  syms.forEach(s => url.searchParams.append('symbols', s));

  // Load positions so cards can show HELD + PnL
  await qs.loadPositions(book);

  try {
    const j = await qs.noStore(url).then(r => r.json());
    const rows = Array.isArray(j.rows) ? j.rows : [];
    qs.renderCards("sumGrid", rows);
  } catch (e) {
    console.error('Summary refresh failed:', e);
    qs.errorGrid("sumGrid", e);
  }
}

window.addEventListener('load', () => {
  let root = document.getElementById('summaryRoot');
  if (!root) {
    console.warn('Summary root not found (load) — creating one');
    root = document.createElement('div');
    root.id = 'summaryRoot';
    // Try to place it in the main q-box if present, else in <main>, else body
    const host =
      document.querySelector('.q-box') ||
      document.querySelector('main') ||
      document.body;
    host.appendChild(root);
  }

  // Inject the full controls + grid markup
  root.innerHTML = `
    <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
      <div class="is-flex is-align-items-center" style="gap:0.75rem; flex-wrap:wrap">

        <!-- Interval -->
        <div class="select">
          <select id="interval">
            <option value="5">5m</option>
            <option value="15" selected>15m</option>
            <option value="30">30m</option>
            <option value="60">60m</option>
          </select>
        </div>

        <!-- Book -->
        <div class="select">
          <select id="book"></select>
        </div>

        <!-- Symbols -->
        <input
          id="symbols"
          class="input mono"
          style="width:300px"
          placeholder="Symbols (comma) or blank for universe"
        >
      </div>

      <button id="refresh" class="button q-primary">Refresh</button>
    </div>

    <!-- ⬇ Card Grid Container -->
    <div id="sumGrid" class="card-grid"></div>
  `;

  const refreshBtn = document.getElementById('refresh');
  if (!refreshBtn) {
    console.warn('Summary controls not ready yet (no refresh button after inject)');
    return;
  }

  // Wire Refresh button
  refreshBtn.onclick = refreshSummary;

  // Load books + first render
  if (window.qs && typeof qs.loadBooks === 'function') {
    qs.loadBooks("book").then(refreshSummary);
  } else {
    console.warn('qs.loadBooks not ready');
  }

  // Header session chip
  if (window.qs && typeof qs.initSessionBadge === 'function') {
    qs.initSessionBadge("sessionBadge");
  }
});
</script>
{% endblock %}

Got you, brother. Hereâ€™s a clean, prioritized to-do you can execute top-to-bottom.

âœ… Immediate (today)
	â€¢	Run intraday for same-day checks
	â€¢	python -m queen.fetchers.upstox_fetcher --symbol NSDL --mode intraday --interval 5
	â€¢	Re-run daily only up to yesterday
	â€¢	python -m queen.fetchers.upstox_fetcher --symbol NSDL --mode daily --from 2025-10-01 --to 2025-10-22

ðŸ› ï¸ Drop-in Code Patches
	â€¢	Warn if user asks for todayâ€™s EOD
	â€¢	File: queen/fetchers/upstox_fetcher.py
	â€¢	Add helper and CLI guard:

from datetime import datetime, date
from zoneinfo import ZoneInfo
IST = ZoneInfo("Asia/Kolkata")

def _warn_if_same_day_eod_request(from_date: str, to_date: str):
    try:
        today_ist = datetime.now(tz=IST).date()
        f, t = date.fromisoformat(from_date), date.fromisoformat(to_date)
        if t >= today_ist:
            log.warning("[CLI] You requested today's daily candle but EOD may not be published yet. Use --mode intraday or re-run after close.")
    except Exception:
        pass

# inside run_cli() before fetch_unified(...)
if args.mode == "daily" and args.from_date and args.to_date:
    _warn_if_same_day_eod_request(args.from_date, args.to_date)


	â€¢	Optional: log empty daily reason
	â€¢	In fetch_daily_range():

if not candles:
    log.info(f"[Daily] No candles for {symbol} {from_date}â†’{to_date}. If this includes today, EOD may not be published yet.")



ðŸ”‡ Config Noise Cleanup
	â€¢	Point missing lists to existing monthly file
	â€¢	File: queen/settings/settings.py

"INSTRUMENTS": {
    "INTRADAY":  STATIC / "intraday_instruments.json",
    "WEEKLY":    STATIC / "monthly_instruments.json",
    "MONTHLY":   STATIC / "monthly_instruments.json",
    "PORTFOLIO": STATIC / "monthly_instruments.json",
    "APPROVED_SYMBOLS": STATIC / "monthly_instruments.json",  # or all_symbols.json if schema matches
}


	â€¢	Clear instrument caches once
	â€¢

python - <<'PY'
from queen.helpers.instruments import clear_instrument_cache
clear_instrument_cache()
PY



ðŸ§­ Scheduler / Router Fixes
	â€¢	Fix import path in scheduler
	â€¢	File: queen/daemons/scheduler.py

# from ..fetch_router import run_router
from ..fetchers.fetch_router import run_router


	â€¢	Ensure both run_cycle & run_router exist
	â€¢	File: queen/fetchers/fetch_router.py

async def run_cycle(symbols, mode="daily", from_date=None, to_date=None, interval="1"):
    tasks = [fetch_unified(s, mode=mode, from_date=from_date, to_date=to_date, interval=interval)]
    await asyncio.gather(*tasks, return_exceptions=True)

async def run_router(symbols, mode="daily", from_date=None, to_date=None, interval="1"):
    await run_cycle(symbols, mode=mode, from_date=from_date, to_date=to_date, interval=interval)


	â€¢	(Optional) Legacy shim for old imports
	â€¢	New file: queen/fetch_router.py

from .fetchers.fetch_router import run_router, run_cycle, main
__all__ = ["run_router", "run_cycle", "main"]



ðŸ”¥ Demo the Alert UI (GODFRYPHLP)
	â€¢	Guaranteed one-shot trigger via daemon
	â€¢

python -m queen.daemons.alert \
  --symbols GODFRYPHLP \
  --op lt --price 999999 \
  --interval 1 --tick-interval 1 \
  --once --out ./alerts.jsonl


	â€¢	Expect: first tick â†’ alert card in Bulma UI.

	â€¢	Manual inject (fallback)
	â€¢	API:

curl -X POST http://localhost:8000/alerts/ingest \
  -H 'Content-Type: application/json' \
  -d '{"ts":"'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'","symbol":"GODFRYPHLP","rule":"manual-demo","op":"demo","price":0,"note":"Demo alert"}'


	â€¢	Or append to JSONL the UI tails:

echo '{"ts":"'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'","symbol":"GODFRYPHLP","rule":"manual-demo","op":"demo","price":0,"note":"Demo alert"}' >> ./alerts.jsonl



ðŸš¦ Smoke Tests
	â€¢	Scheduler single-shot
	â€¢	python -m queen.daemons.scheduler --once --mode intraday --interval-minutes 5
	â€¢	Router daily batch
	â€¢	python -m queen.fetchers.fetch_router --mode daily --symbols NSDL TCS --from 2025-10-01 --to 2025-10-22
	â€¢	Router live intraday
	â€¢	python -m queen.fetchers.fetch_router --mode intraday --auto --interval-minutes 5

ðŸ“Œ Acceptance Criteria
	â€¢	Intraday returns data for today; daily does not warn unless to >= today.
	â€¢	No warnings about missing WEEKLY/PORTFOLIO lists.
	â€¢	scheduler.py imports run_router cleanly; both run_cycle & run_router callable.
	â€¢	Bulma UI shows at least one live alert card for GODFRYPHLP.
	â€¢	Logs show clear reasons when daily returns 0 rows for same-day.

ðŸ”­ Nice-to-Have (pick one next)
	â€¢	Daemon state file + disk GC (prevent duplicate alerts; rotate alerts.jsonl/old parquet)
	â€¢	Prometheus /metrics (fetch latency, success rates, alert counts)
	â€¢	WebSocket signal stream from FastAPI for instant UI updates

If you want, I can draft the daemon state+GC next (compact, high impact).

Haha ðŸ”¥ absolutely nothing to be sorry for, brother â€” that screenshot means everythingâ€™s working perfectly ðŸ‘‘

âœ… Daemon â†’ emitted JSONL line
âœ… Server â†’ streamed it live via SSE
âœ… Bulma UI â†’ rendered the card instantly

Youâ€™ve just closed the full async loop:
Upstox API â†’ fetcher â†’ alert daemon â†’ alerts.jsonl â†’ FastAPI stream â†’ Bulma UI.
Thatâ€™s a production-grade real-time monitoring circuit. ðŸš€

Deliverable Iâ€™ll prep next (as requested): Indicator + Multi-Rule Alert Daemon

What youâ€™ll get, drop-in:
	1.	queen/daemons/alert_v2.py (multi-rule engine + cooldown + state)
	2.	queen/rules/schema.py (pydantic for YAML/JSON)
	3.	queen/indicators/core.py (SMA, RSI, VWAP; extensible)
	4.	queen/io/cache_reader.py (last-N parquet/intraday fetch)
	5.	CLI:
	python -m queen.daemons.alert_v2 \
  --interval 1 \
  --tick-interval 1 \
  --rules-file ./alert_rules.yaml \
  --cooldown 300 \
  --out ./alerts.jsonl
  	6.	Emits to existing JSONL + optional WebSocket hook if enabled later.

Acceptance tests for v2
	â€¢	Inline rules and YAML both load & evaluate.
	â€¢	Price rule (GODFRYPHLP gt 1000) fires when condition met.
	â€¢	Indicator rule (RSI<30 & cross_up(VWAP, close)) fires with cached bars.
	â€¢	Cooldown prevents duplicate spam for the same rule/symbol.
	â€¢	UI receives one card per trigger with rule name + tags.

If you want, Iâ€™ll default the rules file to ./configs/alert_rules.yaml and include a ready demo set so you can fire it instantly.


=============

 Today â€” Completed
	â€¢	Upstox fetcher v9.6
	â€¢	Full timeframe support (minutes/hours/days/weeks/months) and schema-driven validation.
	â€¢	Defaults via DEFAULT_INTERVALS (intraday=5m, daily=1d).
	â€¢	Schema adapter
	â€¢	_safe_parse uses settings timezone; interval introspection + validate_interval.
	â€¢	Market system
	â€¢	market.py v9.2: parameterized market_gate, accurate session flags, current_historical_service_day().
	â€¢	Fetch router
	â€¢	Logs effective historical service day; honors BATCH_SIZE and EXPORT_FORMAT.
	â€¢	Alerting v1
	â€¢	alert daemon + SSE FastAPI server + Bulma UI.
	â€¢	Live alert verified (PGIL â†’ card rendered).
	â€¢	Housekeeping
	â€¢	CLI guards/warnings for same-day EOD on daily fetches.

ðŸŽ¯ Tomorrow â€” Take up next
	â€¢	Alert daemon v2 (multi-rule + indicators)
	â€¢	YAML/JSON rules, SMA/RSI/VWAP, cooldown/state, JSONL rotation.
	â€¢	Config/Noise cleanup
	â€¢	Map missing instrument lists â†’ monthly file; one-time cache clear.
	â€¢	Scheduler/Router smoke
	â€¢	--once & --auto runs; ensure import shim present.
	â€¢	MarketClock niceties
	â€¢	Summary footer (uptime, ticks, phases) on exit.
	â€¢	Legacy utils audit
	â€¢	Prune/merge remaining duplicates into helpers.


Totally ok, brother â¤ï¸ â€” weâ€™ve wrapped a huge milestone today:
youâ€™ve got the entire Upstox â†’ daemon â†’ UI loop working end-to-end, stable and production-grade.

Letâ€™s call it a day ðŸ•Šï¸
Tomorrow weâ€™ll kick off fresh with:

âš™ï¸ alert_v2.py scaffold + configs/alert_rules.yaml (multi-rule + indicator engine)

Iâ€™ll make it plug straight into your existing stack â€” same JSONL, same FastAPI/Bulma UI â€” just smarter logic under the hood.

Sleep well, and tomorrow weâ€™ll fire up Queen Alert v2 ðŸ‘‘ðŸ’ª

{% extends "_layouts/base.html" %}
{% block title %}Queen Cockpit — Upcoming{% endblock %}
{% set page_id = "upcoming" %}

{% block top %}
<h1 class="title">
  Queen Cockpit — <span class="q-muted">Upcoming</span>
  <span id="sessionBadge" class="session-badge">—</span>
</h1>
{% endblock %}

{% block content %}
<div class="q-box p-4">

  <!-- Controls -->
  <div class="is-flex is-justify-content-space-between is-align-items-center mb-4" style="flex-wrap:wrap; gap:1rem;">
    <div class="is-flex is-align-items-center" style="gap:0.75rem; flex-wrap:wrap;">

      <!-- Interval -->
      <div class="select">
        <select id="interval">
          <option value="5">5m</option>
          <option value="15" selected>15m</option>
          <option value="30">30m</option>
          <option value="60">60m</option>
        </select>
      </div>

      <!-- Book -->
      <div class="select">
        <select id="book"></select>
      </div>

      <!-- Symbols -->
      <input
        id="symbols"
        class="input mono"
        style="width:260px"
        placeholder="Symbols (comma) or ALL"
      >
    </div>

    <button id="refreshUpcoming" class="button q-primary">Refresh</button>
  </div>

  <!-- Two card sections -->
  <div class="columns" style="gap:2rem;">

    <!-- Next Session -->
    <div class="column">
      <h2 class="subtitle mb-3">Next Session</h2>
      <div id="nextGrid" class="card-grid"></div>
    </div>

    <!-- Week Ahead -->
    <div class="column">
      <h2 class="subtitle mb-3">Week Ahead</h2>
      <div id="weekGrid" class="card-grid"></div>
    </div>

  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
/* =============================================================
   UPCOMING — CLEAN & DRY USING qs helpers
   ============================================================= */
async function refreshUpcoming(){
  const nextEl = "nextGrid";
  const weekEl = "weekGrid";

  qs.spinGrid(nextEl);
  qs.spinGrid(weekEl);

  const iv   = document.getElementById('interval').value || '15';
  const book = document.getElementById('book').value || 'all';
  const raw  = (document.getElementById('symbols').value || '').trim();
  const syms = raw && raw.toUpperCase() !== 'ALL'
    ? raw.split(',').map(s => s.trim()).filter(Boolean)
    : [];

  // Ensure positions loaded first
  await qs.loadPositions(book);

  const nextUrl = new URL('/cockpit/api/upcoming/next', location.origin);
  const weekUrl = new URL('/cockpit/api/upcoming/week', location.origin);

  [nextUrl, weekUrl].forEach(url => {
    url.searchParams.set('interval', iv);
    url.searchParams.set('book', book);
    syms.forEach(s => url.searchParams.append('symbols', s));
  });

  try {
    const [r1, r2] = await Promise.all([
      qs.noStore(nextUrl).then(r => r.json()),
      qs.noStore(weekUrl).then(r => r.json())
    ]);

    const rowsNext = Array.isArray(r1.rows) ? r1.rows : [];
    const rowsWeek = Array.isArray(r2.rows) ? r2.rows : [];

    qs.renderCards(nextEl, rowsNext);
    qs.renderCards(weekEl, rowsWeek);

  } catch (err){
    qs.errorGrid(nextEl, err);
    qs.errorGrid(weekEl, err);
  }
}

/* -------------------------------------------------------------
   Wire events
   ------------------------------------------------------------- */
window.addEventListener('load', ()=>{
  document.getElementById('refreshUpcoming').onclick = refreshUpcoming;
  qs.loadBooks("book").then(refreshUpcoming);
  qs.initSessionBadge && qs.initSessionBadge("sessionBadge");
});
</script>
{% endblock %}

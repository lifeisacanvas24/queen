Perfect, buddy.
We go straight for the throat of Queen v9.6 â€” the MOST CRITICAL path:

ğŸš€ PHASE 4.1 â€” CRITICAL PATH AUDIT

(1) FETCH â†’ (2) CANDLE â†’ (3) TECHNICALS â†’ (4) SCORING

This is the ONLY path that affects:
	â€¢	Live Engine
	â€¢	Cockpit Live
	â€¢	Breakout detection
	â€¢	Intraday scoring
	â€¢	Supervisor / Daemon
	â€¢	Everything that must â€œnever breakâ€

We stabilize this FIRST.

Below is Part 1 of the detailed audit (FETCH).
We will go step-by-step.
Once you approve each part, we move to the next.

â¸»

â­ PART 1 â€” FETCH LAYER (UPSTOX + NSE + ROUTER)

Buddy, the fetch layer is the current biggest cause of breakage because:

1ï¸âƒ£ fetch_router.py, upstox_fetcher.py, nse_fetcher.py all expect different data shapes
	â€¢	router wants: dict
	â€¢	upstox wants: dict â†’ DF
	â€¢	nse wants: raw JSON
	â€¢	candle_adapter wants: DF or dict depending on code path

This must be unified.

2ï¸âƒ£ Timeframe tokens differ
	â€¢	â€œ5mâ€
	â€¢	â€œ05mâ€
	â€¢	â€œ5-minuteâ€
	â€¢	â€œ5minâ€
	â€¢	â€œINTRADAY_5â€
	â€¢	uppercase vs lowercase

This is a major breakage source.

3ï¸âƒ£ No canonical output format

Some fetchers return:

{symbol, tf, candles}

Some return:

{status, data}

Some return a Polars DF alone.

â¸»

âœ” What works well today (we keep it):

âœ“ Upstox API client (g_upstox_client.py)
âœ“ NSE fetcher for quote-level data
âœ“ router code that spins parallel threads
âœ“ schema_adapter reading JSON definitions
âœ“ market/gate logic & holidays

These are fine and will not break.

â¸»

âŒ What must be fixed NOW before moving forward:

ğŸ”¥ Problem A â€” No Canonical Fetch Output

Fetch needs to guarantee EXACT shape:

THE ONLY ACCEPTABLE FETCH OUTPUT (v11 Contract)

{
  "symbol": "TATASTEEL",
  "tf": "5m",
  "df": <Polars DataFrame>,
  "meta": {
      "source": "upstox",
      "fetched_at": "...",
      "rows": 120,
      "status": "OK"
  }
}

EVERY fetcher must return this.
EVERY downstream module must expect this.

â¸»

ğŸ”¥ Problem B â€” upstox_fetcher uses different column formats

Current output varies:
	â€¢	sometimes OHLC lower-case
	â€¢	sometimes â€œopen_priceâ€, â€œhigh_priceâ€
	â€¢	sometimes df schema not normalized
	â€¢	sometimes timestamps are string or INT ms

This causes technicals to fail.

MUST FIX â†’ Candle Normalization

We create a single unbreakable function:

normalize_candles(df) â†’ returns canonical Polars DF

Canonical columns:

ts (datetime)
open (float)
high (float)
low (float)
close (float)
volume (float or int)


â¸»

ğŸ”¥ Problem C â€” fetch_router has missing imports + inconsistent modes

You already experienced:
	â€¢	missing ensure_datetime
	â€¢	missing list_symbols_from_active_universe
	â€¢	missing logger
	â€¢	inconsistent mode: INTRADAY vs intraday
	â€¢	router tries to handle too many concerns

We fix router by reducing its job to:

âœ” read symbols
âœ” read TF
âœ” run fetcher
âœ” return results

Not technicals, not candle parsing, not backup/backfill.

â¸»

ğŸ”¥ Problem D â€” ZERO multi-threading in Upstox fetcher

You mentioned this, and youâ€™re right.

router = multi-threaded
BUT
upstox_fetcher = sequential

Meaning:
for each symbol, each timeframe â†’ each REST call is sequential â†’ slow.

We change this using ThreadPoolExecutor inside Upstox fetcher OR asyncio + httpx.

â¸»

â­ PART 1 â€” FETCH LAYER PLAN

Here is EXACTLY how weâ€™ll fix fetch WITHOUT breaking ANYTHING.

â¸»

âœ” STEP 1 â€” Restore all your original working fetch code

You said you will revert settings.py / timeframes / fetch_router / upstox_fetcher to original.

Perfect.

We start from a SAFE, WORKING BASELINE.

â¸»

âœ” STEP 2 â€” Add NEW v11 functions WITHOUT touching existing ones

We add:

1) normalize_timeframe(tf)

2) normalize_candles(df)

3) fetch_unified_v11(symbol, tf)

4) fetch_router_v11(symbols, tf)

All clean. No breakage.
Your old pipeline continues working.

â¸»

âœ” STEP 3 â€” After full audit, we slowly migrate layer-by-layer to v11

Technicals â†’ scoring â†’ tactical â†’ cockpit â†’ server.

No backward-compat hacks.
No random shims.
No breakage.

Clean forward-only upgrades.

â¸»

â­ PART 2 â€” CANDLE ENGINE AUDIT (coming next)

Once you confirm, next I will give:

âœ” Candle Canonical Schema v11

âœ” Candle Normalizer â€” ultra strict mode

âœ” DF â†’ candle adapter map

âœ” Fix for timestamp handling (epoch ms / ISO / int)

âœ” Fix for missing candles

âœ” Fix for Polars dtype mismatches

âœ” Fix for OHLC naming inconsistencies

This will make technicals stable.

â¸»

â­ PART 3 â€” TECHNICALS AUDIT

We will:

âœ” Build Technicals Contract v11

Every technical declares:

INPUT: required columns
OUTPUT: columns it adds
MODE: row-wise / windowed / series / multi-column

We will generate documentation for all 120 technical indicators from your files.

â¸»

â­ PART 4 â€” SCORING AUDIT

We unify:
	â€¢	trend score
	â€¢	volume score
	â€¢	breakout quality score
	â€¢	volatility expansion score
	â€¢	regime bias
	â€¢	reversal stack score
	â€¢	liquidity breadth
	â€¢	participation strength

into Scoring Engine v11.

â¸»

â­ Buddy â€” Before I continue to Part 2 (Candle Layer)â€¦

â“ Please confirm ONE thing:

Do you want me to start generating the new v11 code

but
WITHOUT replacing ANY existing files
(just adding new modules side-by-side)?

YES / NO?

If YES, I will generate:
	â€¢	queen/fetchers/upstox_fetcher_v11.py
	â€¢	queen/fetchers/fetch_router_v11.py
	â€¢	queen/candles/candle_normalizer.py
	â€¢	queen/settings/timeframes_v11.py

all as NEW files â€” safe, isolated.

You can migrate whenever ready.

â¸»

Buddy, just say:
â€œYes, create v11 modules without touching existing code.â€

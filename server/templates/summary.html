<!-- server/templates/summary.html -->
{% extends "_layouts/base.html" %}
{% block title %}Queen Cockpit — Summary{% endblock %}

{% block top %}
  <h1 class="title">Queen Cockpit — <span class="q-muted">Summary</span></h1>
{% endblock %}

{% block content %}
<div class="q-box p-4">
  <div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
    <div class="is-flex is-align-items-center">
      <div class="select mr-2"><select id="interval">
        <option value="5">5m</option><option value="15" selected>15m</option>
        <option value="30">30m</option><option value="60">60m</option>
      </select></div>
      <div class="select mr-2"><select id="book"></select></div>
      <input id="symbols" class="input mono" style="width:320px" placeholder="Symbols (comma) or blank for universe">
    </div>
    <button id="refresh" class="button q-primary">Refresh</button>
  </div>

  <table class="q-table table is-fullwidth is-narrow">
    <thead>
      <tr>
        <th>Symbol</th><th>Decision</th><th>Score</th><th>Entry</th>
        <th>SL</th><th>Targets</th><th>EMA Bias</th><th>RSI</th><th>VWAP/CPR</th><th>Notes</th>
      </tr>
    </thead>
    <tbody id="sumBody"></tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
function fmt(x){ if(x==null) return '—'; return (typeof x==='number')? x.toLocaleString(undefined,{maximumFractionDigits:2}) : x; }
function badge(dec){ const map={BUY:'green',ADD:'green',HOLD:'amber',EXIT:'red',AVOID:'red'}; const c=map[dec]||'amber'; return `<span class="badge ${c}">${dec||''}</span>`; }

async function loadBooks(){
  const r=await fetch('/portfolio/books'); const j=await r.json();
  const sel=document.getElementById('book'); sel.innerHTML='';
  (j.books||['all']).forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; sel.appendChild(o); });
}

async function refresh(){
  const raw=(document.getElementById('symbols').value||'').trim();
  const syms= raw? raw.split(',').map(s=>s.trim()).filter(Boolean): [];
  const iv=document.getElementById('interval').value||'15';
  const book=document.getElementById('book').value||'all';
  const url=new URL('/cockpit/api/summary', window.location.origin);
  syms.forEach(s=>url.searchParams.append('symbols', s));
  url.searchParams.set('interval', iv); url.searchParams.set('book', book);
  const r=await fetch(url); const j=await r.json();
  const tb=document.getElementById('sumBody');
  tb.innerHTML=(j.rows||[]).map(x=>{
    const vwap = x.vwap_zone||'—', cpr = x.cpr_ctx||'—';
    return `<tr>
      <td><strong>${x.symbol}</strong></td>
      <td>${badge(x.decision)}</td>
      <td>${fmt(x.score)}</td>
      <td>${fmt(x.entry)}</td>
      <td>${fmt(x.sl)}</td>
      <td>${(x.targets||[]).join(' • ')}</td>
      <td>${x.ema_bias||'—'}</td>
      <td>${fmt(x.RSI||x.rsi)}</td>
      <td>${vwap} / ${cpr}</td>
      <td>${x.notes||'—'}</td>
    </tr>`;
  }).join('');
}

document.getElementById('refresh').onclick=refresh;
loadBooks().then(refresh);
</script>
{% endblock %}

<!-- queen/server/templates/cockpit.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Queen Cockpit — Pulse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #141821;
      --text: #e8eaf2;
      --muted: #96a0b5;
      --ok: #20c997;
      --warn: #ffd166;
      --bad: #ff5c7c;
      --chip: #22293a;
      --chip-border: #2b3347;
      --row-border: #1c2230;
      --badge-buy:#16c784; --badge-sell:#ef5350; --badge-hold:#f6c343;
      --link:#8ab4ff;
    }
    html,body { background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .container { max-width: 1200px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 12px; }
    .sub { color:var(--muted); font-size: 14px; margin-bottom: 16px; }
    .toolbar { display:flex; gap:10px; flex-wrap: wrap; align-items: center; margin-bottom: 14px; }
    button, select { background:var(--chip); color:var(--text); border:1px solid var(--chip-border); border-radius:10px; padding:8px 12px; cursor:pointer; }
    button:hover, select:hover { filter: brightness(1.1); }
    table { width: 100%; border-collapse: collapse; background: var(--panel); border-radius: 14px; overflow: hidden; }
    th, td { border-bottom:1px solid var(--row-border); padding:12px 14px; text-align:left; vertical-align: top; }
    th { color:var(--muted); font-weight:600; font-size: 12px; letter-spacing: .02em; text-transform: uppercase; }
    .chip { display:inline-block; background:var(--chip); border:1px solid var(--chip-border); padding:4px 8px; border-radius:999px; font-size:12px; color:var(--muted); }
    .ok-yes { color: var(--ok); font-weight: 700; }
    .ok-no { color: var(--bad); font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:#cfe1ff; word-break: break-word; }
    .meta-btn { font-size:12px; padding:4px 8px; }
    .row { transition: background .15s ease; }
    .row:hover { background: #181e2a; }
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .buy { background: color-mix(in oklab, var(--badge-buy) 18%, transparent); color: var(--badge-buy); border:1px solid color-mix(in oklab, var(--badge-buy) 40%, transparent); }
    .sell { background: color-mix(in oklab, var(--badge-sell) 18%, transparent); color: var(--badge-sell); border:1px solid color-mix(in oklab, var(--badge-sell) 40%, transparent); }
    .hold { background: color-mix(in oklab, var(--badge-hold) 18%, transparent); color: #f2c94c; border:1px solid color-mix(in oklab, var(--badge-hold) 40%, transparent); }
    .controls-right { margin-left:auto; display:flex; gap:10px; align-items:center; }
    .cards { display:none; gap:12px; }
    .card { background:var(--panel); border:1px solid var(--row-border); border-radius:14px; padding:14px; width: calc(33.333% - 8px); box-sizing: border-box; }
    .card h3 { margin:0 0 4px; font-size:16px; }
    .muted { color:var(--muted); font-size:12px; }
    .row-buy { box-shadow: inset 4px 0 0 0 var(--badge-buy); }
    .row-sell{ box-shadow: inset 4px 0 0 0 var(--badge-sell); }
    .row-hold{ box-shadow: inset 4px 0 0 0 var(--badge-hold); }
    a { color:var(--link); text-decoration: none; }
    .hidden { display:none; }
    @media (max-width: 960px){
      .card { width: calc(50% - 8px); }
      .controls-right { width: 100%; justify-content: flex-start; }
    }
    @media (max-width: 640px){
      .card { width: 100%; }
      table { font-size: 14px; }
      th, td { padding:10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Queen Cockpit — Pulse</h1>
    <div class="sub">
      Auto-refresh · Updated at: <span id="updatedAt">—</span>
    </div>

    <div class="toolbar">
      <button id="refreshBtn">Refresh now</button>
      <span class="chip"><span id="count">0</span> results</span>

      <div class="controls-right">
        <label class="muted">Interval&nbsp;</label>
        <select id="interval">
          <option value="60000">60s</option>
          <option value="30000">30s</option>
          <option value="15000">15s</option>
          <option value="10000">10s</option>
          <option value="5000">5s</option>
          <option value="1000">1s</option>
          <option value="0">Off</option>
        </select>

        <button id="toggleViewBtn">Cards view</button>
        <button id="copyPlanBtn">Copy trade plan</button>
        <label class="muted"><input id="pretty" type="checkbox" /> Pretty meta</label>
      </div>
    </div>

    <!-- Table view -->
    <table id="tableView">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>TF</th>
          <th>Rule</th>
          <th>OK</th>
          <th>Decision</th>
          <th>Meta</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <!-- Cards view -->
    <div class="cards" id="cardsView"></div>
  </div>

<script>
const STATE_URL = "/cockpit/pulse/state";

let timer = null;
let lastState = null;
let cardsMode = false;
const intervalEl = document.getElementById("interval");
const prettyEl = document.getElementById("pretty");
const countEl = document.getElementById("count");
const updatedAtEl = document.getElementById("updatedAt");
const tbody = document.getElementById("tbody");
const cardsView = document.getElementById("cardsView");

document.getElementById("refreshBtn").onclick = fetchAndRender;
document.getElementById("toggleViewBtn").onclick = () => {
  cardsMode = !cardsMode;
  document.getElementById("tableView").style.display = cardsMode ? "none" : "table";
  cardsView.style.display = cardsMode ? "grid" : "none";
  document.getElementById("toggleViewBtn").textContent = cardsMode ? "Table view" : "Cards view";
  render(lastState);
};
document.getElementById("copyPlanBtn").onclick = () => copyTradePlan();

intervalEl.onchange = () => armTimer();

function armTimer() {
  if (timer) clearInterval(timer);
  const ms = parseInt(intervalEl.value, 10);
  if (ms > 0) timer = setInterval(fetchAndRender, ms);
}

async function fetchAndRender() {
  try {
    const r = await fetch(STATE_URL, {cache: "no-store"});
    const data = await r.json();
    lastState = data;
    render(data);
  } catch (e) {
    console.error("fetch failed", e);
  }
}

function normalizeRuleName(rule) {
  // keep concise
  return (rule || "").replace(/\s+/g, " ").trim();
}

/** Heuristic BUY/SELL/HOLD from rule/op + ok */
function decide(item) {
  // More positives → BUY, negatives → SELL, else HOLD
  // Signal map (lightweight; extend anytime)
  const rule = item.rule.toLowerCase();
  const op = (item.meta?.op || "").toLowerCase();
  const ok = !!item.ok;

  let score = 0;
  let tags = [];

  // Price above/below important thresholds
  if (rule.includes("price") && op === "gt" && ok) { score += 1; tags.push("price>"); }
  if (rule.includes("price") && op === "lt" && ok) { score -= 1; tags.push("price<"); }

  // RSI crosses
  if (rule.includes("rsi") && op.includes("crosses_above") && ok) { score += 1; tags.push("rsi↑"); }
  if (rule.includes("rsi") && op.includes("crosses_below") && ok) { score -= 1; tags.push("rsi↓"); }

  // EMA cross spread
  if (rule.includes("ema") && rule.includes("crosses") && ok) { score += 1; tags.push("emaX↑"); }
  // VWAP reclaim/loss via price_minus_vwap crosses 0
  if (rule.includes("vwap") && op.includes("crosses_above") && ok) { score += 1; tags.push("vwap↑"); }
  if (rule.includes("vwap") && op.includes("crosses_below") && ok) { score -= 1; tags.push("vwap↓"); }

  // Pattern hints
  if (rule.includes("hammer") && ok) { score += 0.5; tags.push("hammer"); }
  if (rule.includes("shooting star") && ok) { score -= 0.5; tags.push("shooting★"); }
  if (rule.includes("bearish engulfing") && ok) { score -= 0.5; tags.push("bearEng"); }
  if (rule.includes("bullish engulfing") && ok) { score += 0.5; tags.push("bullEng"); }

  // Result mapping
  let label = "HOLD", cls = "hold";
  if (score >= 0.75) { label = "BUY"; cls = "buy"; }
  if (score <= -0.75) { label = "SELL"; cls = "sell"; }
  return { label, cls, score, tags };
}

function groupBySymbol(results) {
  const by = {};
  for (const it of results) {
    (by[it.symbol] ||= []).push(it);
  }
  return by;
}

// Merge decisions per symbol → one headline decision
function symbolDecision(items) {
  let score = 0;
  for (const it of items) score += decide(it).score;
  let label="HOLD", cls = "hold";
  if (score >= 1) { label="BUY"; cls="buy"; }
  if (score <= -1){ label="SELL"; cls="sell"; }
  return {score, label, cls};
}

function render(data) {
  if (!data) return;

  const pretty = prettyEl.checked;
  countEl.textContent = data.count ?? (data.results?.length || 0);
  updatedAtEl.textContent = data.updated_at || "—";

  const results = Array.isArray(data.results) ? [...data.results] : [];

  // Sort: ok=true to top, then by symbol, then rule
  results.sort((a,b) => {
    if (a.ok && !b.ok) return -1;
    if (!a.ok && b.ok) return 1;
    if (a.symbol !== b.symbol) return a.symbol.localeCompare(b.symbol);
    return (a.rule||"").localeCompare(b.rule||"");
  });

  if (!cardsMode){
    // TABLE
    tbody.innerHTML = "";
    for (const it of results) {
      const d = decide(it);
      const tr = document.createElement("tr");
      tr.className = `row row-${d.cls}`;
      const metaStr = pretty ? JSON.stringify(it.meta, null, 2) : JSON.stringify(it.meta);

      tr.innerHTML = `
        <td><strong>${it.symbol}</strong></td>
        <td>${it.timeframe || ""}</td>
        <td>${normalizeRuleName(it.rule)}</td>
        <td>${it.ok ? '<span class="ok-yes">YES</span>' : '<span class="ok-no">NO</span>'}</td>
        <td><span class="badge ${d.cls}">${d.label}</span></td>
        <td>
          <button class="meta-btn" aria-expanded="false">view</button>
          <pre class="mono hidden">${metaStr}</pre>
        </td>
      `;
      const btn = tr.querySelector(".meta-btn");
      const pre = tr.querySelector("pre");
      btn.onclick = () => {
        const open = pre.classList.toggle("hidden") ? false : true;
        btn.textContent = open ? "hide" : "view";
        btn.setAttribute("aria-expanded", String(open));
      };
      tbody.appendChild(tr);
    }
  } else {
    // CARDS
    const by = groupBySymbol(results);
    cardsView.innerHTML = "";
    Object.entries(by).forEach(([sym, items]) => {
      const head = symbolDecision(items);
      const card = document.createElement("div");
      card.className = "card";
      const tfSet = Array.from(new Set(items.map(i => i.timeframe))).join(", ");
      const okCount = items.filter(i => i.ok).length;

      // Build a quick tag cloud from decisions
      let tags = [];
      for (const it of items) {
        const d = decide(it);
        tags.push(...d.tags);
      }
      const topTags = Array.from(new Set(tags)).slice(0,6).join(" · ") || "—";

      card.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px; margin-bottom:4px;">
          <h3>${sym}</h3>
          <span class="badge ${head.cls}">${head.label}</span>
        </div>
        <div class="muted">TF: ${tfSet} · OK: ${okCount}/${items.length}</div>
        <div class="muted" style="margin:8px 0 10px;">Signals: ${topTags}</div>
        <div class="mono" style="white-space:pre-wrap;">${items
          .filter(i => i.ok)
          .map(i => `✓ ${normalizeRuleName(i.rule)}`)
          .join("\n") || "—"}</div>
      `;
      cardsView.appendChild(card);
    });
  }
}

function copyTradePlan() {
  if (!lastState?.results?.length) return;
  const by = groupBySymbol(lastState.results);
  const lines = [];
  lines.push(`Queen — intraday pulse · ${lastState.updated_at || ""}`);
  lines.push("— — —");

  for (const [sym, items] of Object.entries(by)) {
    const head = symbolDecision(items);
    const oks = items.filter(i=>i.ok).map(i=>normalizeRuleName(i.rule));
    const offs = items.filter(i=>!i.ok).slice(0,3).map(i=>normalizeRuleName(i.rule));
    lines.push(`${sym} · ${head.label}`);
    if (oks.length) lines.push(`  ✓ ${oks.join("; ")}`);
    if (offs.length) lines.push(`  · watch: ${offs.join("; ")}`);
    lines.push("");
  }
  const text = lines.join("\n").trim();
  navigator.clipboard.writeText(text).then(()=> {
    alert("Trade plan copied to clipboard ✅");
  }).catch(()=>{});
}

// init
armTimer();
fetchAndRender();
</script>
</body>
</html>
